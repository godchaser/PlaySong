@(songs: List[Song])

@admin("") {

    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/bootstrap-multiselect.css")">
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/bootstrap.min.css")">
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/dataTables.responsive.css")">

    <script src="@routes.Assets.at("javascripts/jquery-2.1.3.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/bootstrap-multiselect.js")" type="text/javascript"></script>

    <div class="panel-group" id="collapse-accordion">
        <div class="panel panel-default" style="overflow:visible;">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#collapse-accordion" href="#collapse-accordion-one">
                        Songbook creator
                    </a>
                </h4>
            </div>
            <form class="btn-group" id="songbook-form">
                <div class="btn-group">
                    <select id="song-selector" multiple="multiple">
                        @songs.map { song =>
                            @song.songLyrics.zipWithIndex.map{ case (songlyrics, i) =>
                                @if(i==0){
                                    <option id="@song.id" value="@songlyrics.id" data-songkey="@songlyrics.songKey">@song.songName (@songlyrics.songKey)</option>
                                }
                                @if(i>0){
                                    @defining(i + 1) { idx =>
                                        <option id="@song.id" value="@songlyrics.id" data-songkey="@songlyrics.songKey">@song.songName @idx (@songlyrics.songKey)</option>
                                    }
                                }
                            }
                        }
                    </select>
                    <select id="title-font" class="btn btn-group btn-default">
                        <option label="Title font">Title font</option>
                        <option value="1">Arial</option>
                        <option value="2">Droid</option>
                        <option value="3">Courier New</option>
                    </select>
                    <select id="lyrics-font" class="btn btn-group btn-default">
                        <option label="Lyrics font">Lyrics font</option>
                        <option value="1">Courier New</option>
                        <option value="2">Droid Mono</option>
                        <option value="3">Arial</option>
                    </select>
                    <button type="reset" id="reset-button" class="btn btn-default"><i class="fa fa-repeat fa-fw"></i>Reset</button>
                    <button type="button" id="submit-button" class="btn btn-default"><i class="fa fa-book fa-fw"></i>Prepare songbook</button>
                </div>
            </form>
        </div>
        <div>
            <table id="song_table"></table>
        </div>
    </div>

    <script src="@routes.Assets.at("javascripts/jquery.dataTables.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/dataTables.responsive.min.js")" type="text/javascript"></script>

    <script type="text/javascript">

    $ ( document ).ready ( function ( ) {
    // copy song table div to dynamic content div
    $('#dynamiccontent').html($('#collapse-accordion').html());
    // delete initial table div
    $('#collapse-accordion' ).remove();

    $('#song-selector').multiselect({
    enableCaseInsensitiveFiltering: true,
    enableFiltering: true,
    includeSelectAllOption: true,
    inheritClass: true,
    disableIfEmpty: true,
    numberDisplayed: 4,
    enableClickableOptGroups: false,
    nonSelectedText: 'Select songs',
    maxHeight: 400
    });

    function setSelected() {
    console.log("Change Event")
    }


    //reset button
    $('#songbook-form').on('reset', function() {
    $('#song-selector option:selected').each(function() {
        $(this).prop('selected', false);
    });
        $('#reset').multiselect('refresh');
    });
    var dataSet = [];
    var songBookData;
    var songBookPrepared = false;
    //generate button
    $('#submit-button').on('click', function() {
    if (songBookPrepared===false){
    console.log("click1");
        var songIds= [];
        $('#song-selector option:selected').each(function() {
            var songObject = new Object();
            var songValue = new Object();
            songValue.id = $(this).attr('id');
            songValue.lyricsID = $(this).val();
            songValue.key = $(this).attr('data-songkey');
            var helper = [];
            helper.push($(this).text());
            helper.push(songValue.id);
            helper.push(songValue.lyricsID);
            helper.push(songValue.key);
            dataSet.push(helper);
            songObject.song = songValue;
            songIds.push(songObject);
        });
        if (songIds===0){
            window.alert("Select songs first");
        }
        else {
            songBookData = new Object();
            songBookData.songs = songIds;
            var songFont = new Object();
            var titleFont = $('#title-font option:selected').text();
            if (titleFont == "Title font"){
                //default
                titleFont = "Arial";
            }
            songFont.titleFont = titleFont;

            var lyricsFont = $('#lyrics-font option:selected').text();
            if (lyricsFont == "Lyrics font"){
                //default
                lyricsFont = "Courier New";
            }
            songFont.lyricsFont = lyricsFont;
            songBookData.fonts = songFont;

            $('#song_table').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="example"></table>' );
            $('#song_table').dataTable( {
                "data": dataSet,
                responsive : true,
                "bJQueryUI" : true,
                "sPaginationType" : "full",
                "dom": 'T<"clear">lfrtip',
                "columns": [
                    { "title": "Song" },
                    { "title": "SongID" },
                    { "title": "LyricsId"},
                    { "title": "SongKey"}
                    ],
                "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                    var songKeySelect = '<select id="songKeySelector_'+aData[2]+'"><option value="C"  >C</option><option value="C#"  >C#</option><option value="D"  >D</option><option value="D#"  >D#</option><option value="E"  >E</option><option value="F"  >F</option><option value="F#"  >F#</option><option value="G"  >G</option><option value="G#"  >G#</option><option value="A"  >A</option><option value="A#"  >A#</option><option value="B"  >B</option></select>';
                    var idx = songKeySelect.indexOf("\""+aData[3]+"\"");
                    var songKeySelect = songKeySelect.slice(0, idx+5) + "selected=\"true\"" + songKeySelect.slice(idx+5);
                    $('td:eq(3)', nRow).html(songKeySelect);
                    var rowId = 'row_'+aData[2];
                    $(nRow).attr('id', rowId);
                    $(rowId + " select").val(aData[3]);
                    return nRow;
                 }
            });
            songBookPrepared = true;
            $('#submit-button').text("Generate Songbook");
        }
        }
    else {
        console.log("click2");
        var chordTable = $('#song_table').dataTable();
        var tableData = chordTable.fnGetData();
        var data = chordTable.$('select').serialize();
        var songIds= [];
        for (var i=0;i<tableData.length;i++){
            tableData[i][2]
            var songObject = new Object();
            var songValue = new Object();
            songValue.id = tableData[i][1];
            songValue.lyricsID = tableData[i][2];
            var songKeySelector = "#songKeySelector_"+ tableData[i][2];
            var key = $( songKeySelector+ " option:selected" ).text();
            songValue.key = key;
            var helper = [];
            helper.push(songValue.id);
            helper.push(songValue.lyricsID);
            helper.push(songValue.key);
            dataSet.push(helper);
            songObject.song = songValue;
            songIds.push(songObject);
        }
        songBookData = new Object();
        songBookData.songs = songIds;

        var songFont = new Object();
        var titleFont = $('#title-font option:selected').text();
        if (titleFont == "Title font"){
            //default
                titleFont = "Arial";
        }
        songFont.titleFont = titleFont;

        var lyricsFont = $('#lyrics-font option:selected').text();
        if (lyricsFont == "Lyrics font"){
                //default
                lyricsFont = "Courier New";
         }

         songFont.lyricsFont = lyricsFont;
         songBookData.fonts = songFont;

        console.log(songBookData);
                    $.ajax("@routes.Application.generateSongbook()", {
                    type: 'POST',
                    data: JSON.stringify(songBookData),
                    success: function (data) {
                        var link = "@routes.Application.downloadAndDeleteFile()"
                        link = link.concat("?hash=" + data);
                        window.location=link;
                    },
                    contentType : 'application/json'
                });
    }

    });

    });
    </script>

}